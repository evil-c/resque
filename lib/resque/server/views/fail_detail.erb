<% @subtabs = resque.queues %>

<% index = 0 %>
<% date_format = "%Y/%m/%d %T %z" %>

<table class="queues" style="width: 100%">
  <% for exp in @exception_list
      (headers ||= []) << %(
        <th>
          <a style="text-decoration:none" href="#{current_queue + '/' + URI.escape(exp.first)}">#{exp.first}</a>
        </th>
      ) 
      (counts ||= []) << %Q(
        <td>
          <a style="text-decoration:none" href="#{current_queue + '/' + URI.escape(exp.first)}">#{exp.last}</a>
        </td>
      )
    end 
    %>
  <tr><%= headers.join(&:strip) %></tr>
  <tr><%= counts.join(&:strip) %></tr>
</table>

<h1>Failed Jobs</h1>
<%unless @fails.empty?%>
  <% target = @exception ? "/#{@queue_name}/#{@exception}" : "/#{@queue_name}" %>
<form method="POST" action="<%=u 'failed/clear' + URI.encode(target) %>" class='clear-failed'>
  <input type='submit' name='' value="Clear Failed <%= @exception || @queue_name %>" />
</form>
<%end%>

<p class='sub'>Showing <%=@start%> to <%= @start + 20 %> of <b><%= size = @total_fails %></b> jobs</p>

<ul class='failed'>
  <%for job in @fails %>
    <% index += 1 %>
    <li>
      <dl>
        <% if job.nil? %>
        <dt>Error</dt>
        <dd>Job <%= index%> could not be parsed; perhaps it contains invalid JSON?</dd>
        <% else %>
        <dt>Worker</dt>
        <dd>
          <a href="<%= u(:workers, job['worker']) %>"><%= job['worker'].split(':')[0...2].join(':') %></a> at <b><span class="time"><%= Time.parse(job['failed_at']).strftime(date_format) %></span></b>
          <% if job['retried_at'] %>
            <div class='retried'>
              Retried <b><span class="time"><%= Time.parse(job['retried_at']).strftime(date_format) %></span></b>
              <a href="<%= u "failed/remove/#{@start + index - 1}" %>" class="remove" rel="remove">Remove</a>
            </div>
          <% else %>
            <div class='controls'>
              <a href="<%= u "failed/requeue/#{@start + index - 1}" %>" rel="retry">Retry</a>
              or
              <a href="<%= u "failed/remove/#{@start + index - 1}" %>" rel="remove">Remove</a>
            </div>
          <% end %>
        </dd>
        <dt>Class</dt>
        <dd><code><%= job['payload'] ? job['payload']['class'] : 'nil' %></code></dd>
        <dt>Arguments</dt>
        <dd><pre><%=h job['payload'] ? show_args(job['payload']['args']) : 'nil' %></pre></dd>
        <dt>Exception</dt>
        <dd><code><%= job['exception'] %></code></dd>
        <dt>Error</dt>
        <dd class='error'>
          <% if job['backtrace'] %>
            <a href="#" class="backtrace"><%= h(job['error']) %></a>
            <pre style='display:none'><%=h job['backtrace'].join("\n") %></pre>
          <% else %>
            <%=h job['error'] %>
          <% end %>
        </dd>
        <% end %>
      </dl>
      <div class='r'>
      </div>
    </li>
  <%end%>
</ul>

<%= partial :next_more, :start => @start, :size => size %>
